name: Build and Run Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  
jobs:
  test:
    timeout-minutes: 15
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    #----------------------------------------------
    #  -----  set-up python  -----
    #----------------------------------------------
    - name: Set up python
      id: setup-python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.11'
    #----------------------------------------------
    #  -----  install & configure poetry  -----
    #----------------------------------------------
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        virtualenvs-create: true
        virtualenvs-in-project: true
        virtualenvs-path: console-test/.venv
    #----------------------------------------------
    #  -----  install dependencies  -----
    #----------------------------------------------
    - name: Install dependencies
      run: poetry install --no-interaction --no-root
    #----------------------------------------------
    #  -----  install vega binaries. -----
    #----------------------------------------------
    - name: Install vega binaries
      run: poetry run python -m vega_sim.tools.load_binaries --force
    #----------------------------------------------
    #  -----  pull console. -----
    #----------------------------------------------
    - name: pull console
      run: |    
        poetry run docker pull vegaprotocol/trading:testnet
    #----------------------------------------------
    #  -----  install playwright. -----
    #----------------------------------------------
    - name: Install Playwright
      run: poetry run playwright install
    #----------------------------------------------
    #  ----- run tests. -----
    #----------------------------------------------
    - name: Run tests
      run:  poetry run pytest --numprocesses 4
    #----------------------------------------------
    #  -----  upload traces  -----
    #----------------------------------------------
    - name: Upload Playwright Trace
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-trace
        path: ./traces/
        retention-days: 15
        

        
        
